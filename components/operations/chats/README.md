# 会话监管功能

## 功能概述

会话监管功能用于后台管理员查看和管理客户与技师之间的聊天记录，支持实时监控、锁定会话等操作。

## 文件结构

```
components/operations/chats/
├── ChatMonitoringPage.tsx    # 主页面组件
├── ChatThreadTable.tsx        # 会话列表表格
├── ChatThreadDrawer.tsx       # 会话详情抽屉
└── index.ts                   # 导出文件

app/dashboard/operations/chats/
├── actions.ts                 # Server Actions
└── page.tsx                   # 路由页面
```

## 功能特性

### 1. 统计卡片
- **活跃会话**: 24小时内有消息的会话数量
- **今日新增**: 今日新建的会话数量
- **已锁定会话**: 被管理员锁定的会话数量

### 2. 筛选功能
- **搜索**: 按参与者姓名搜索
- **会话类型**: 
  - 全部类型
  - 客户↔技师 (c2g)
  - 客服↔客户 (s2c)
  - 客服↔技师 (s2g)
- **仅活跃**: 只显示24小时内有消息的会话
- **有订单**: 只显示有关联订单的会话

### 3. 会话列表
显示以下信息：
- **类型**: 会话类型徽章
- **参与者**: 客户/技师/客服名称
- **关联订单**: 订单号（支持一键复制）
- **最后消息**: 最后一条消息的文本预览（最多30字）
- **最后时间**: 相对时间显示
- **未读数**: 客户和技师的未读消息数
- **状态**: 正常/已锁定
- **操作**: 查看详情、锁定/解锁

### 4. 会话详情
点击"查看"按钮打开侧边抽屉，显示：
- 会话基本信息（类型、状态、最后消息时间）
- 完整聊天记录
  - 发送者头像和名称
  - 消息内容（文本/图片/系统消息）
  - 发送时间
  - 关联订单（如有）

### 5. 锁定/解锁功能
- 管理员可以锁定会话，禁止双方继续发言
- 锁定后会话显示红色"已锁定"徽章
- 可以随时解锁恢复正常

### 6. 订单号一键复制
- 点击订单号旁边的复制按钮
- 自动复制到剪贴板
- 显示成功提示

## 权限要求

需要以下角色之一：
- `superadmin` - 超级管理员
- `admin` - 管理员
- `support` - 客服

## 数据表

### chat_threads（聊天线程表）
- 存储会话基本信息
- 包含参与者ID、类型、锁定状态等

### chat_messages（聊天消息表）
- 存储所有聊天消息
- 支持文本、图片、系统消息

### chat_receipts（消息已读记录表）
- 记录用户最后阅读时间
- 用于计算未读数

## API 接口

### Server Actions

#### getChatStats()
获取会话统计数据

#### getChatThreads(filters)
获取会话列表
- 参数: `ChatThreadFilters`
- 返回: 会话列表和分页信息

#### toggleThreadLock(threadId, isLocked)
锁定/解锁会话
- 参数: 会话ID、锁定状态
- 返回: 操作结果

#### getChatMessages(threadId, page, limit)
获取会话消息列表
- 参数: 会话ID、页码、每页数量
- 返回: 消息列表

## 使用说明

1. 访问 `/dashboard/operations/chats`
2. 查看统计卡片了解整体情况
3. 使用筛选条件查找特定会话
4. 点击"查看"按钮查看完整聊天记录
5. 必要时可以锁定会话禁止发言
6. 点击订单号旁边的复制按钮快速复制

## 注意事项

1. **性能优化**: 未读数计算较耗时，已在后端批量查询优化
2. **实时更新**: 目前需要手动刷新，未来可考虑使用 Realtime 订阅
3. **权限控制**: 所有操作都需要管理员权限，已在 RLS 策略中配置
4. **锁定机制**: 锁定会话后，客户端会收到发送失败提示（需客户端配合）

## 未来优化

- [ ] 支持实时消息推送
- [ ] 支持消息搜索
- [ ] 支持导出聊天记录
- [ ] 支持批量操作
- [ ] 支持消息撤回
- [ ] 支持发送系统消息

## 技术栈

- Next.js 15 App Router
- Server Components + Server Actions
- shadcn/ui 组件库
- Supabase 数据库
- TypeScript
