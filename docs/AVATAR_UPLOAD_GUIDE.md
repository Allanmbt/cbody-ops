# æŠ€å¸ˆå¤´åƒä¸Šä¼ åŠŸèƒ½å®ç°è¯´æ˜

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. å›¾ç‰‡è£å‰ªç»„ä»¶ (`GirlImageCropper.tsx`)
- **ä½ç½®**: `components/girls/GirlImageCropper.tsx`
- **åŠŸèƒ½ç‰¹æ€§**:
  - âœ… æ”¯æŒä¸‰ç§è£å‰ªæ¯”ä¾‹é€‰æ‹©ï¼š
    - 3:4 (ç«–ç‰ˆ) - é»˜è®¤æ¯”ä¾‹
    - 1:1 (æ–¹å½¢)
    - 9:16 (è¶…ç«–)
  - âœ… å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½ (0.5x ~ 3x)
  - âœ… å›¾ç‰‡æ—‹è½¬åŠŸèƒ½ (90åº¦å¢é‡)
  - âœ… é‡ç½®åŠŸèƒ½
  - âœ… **ä¿æŒåŸå›¾è´¨é‡**ï¼šè´¨é‡å‚æ•°è®¾ç½®ä¸º 1.0ï¼Œæ— å‹ç¼©

### 2. å¤´åƒä¸Šä¼ é€»è¾‘ (`GirlFormDialog.tsx`)
- **ä½ç½®**: `components/girls/GirlFormDialog.tsx`
- **å®ç°æµç¨‹**:
  1. ç”¨æˆ·é€‰æ‹©å›¾ç‰‡ â†’ è§¦å‘è£å‰ªå™¨
  2. è£å‰ªå®Œæˆ â†’ ç”Ÿæˆ Blobï¼Œè½¬æ¢ä¸º File
  3. è¡¨å•æäº¤æ—¶ â†’ ä¸Šä¼ åˆ° Supabase Storage (`upload/avatars/`)
  4. ä¸Šä¼ æˆåŠŸ â†’ è·å– publicUrl
  5. ä¿å­˜åˆ°æ•°æ®åº“ `girls.avatar_url`

- **ä¸Šä¼ é…ç½®**:
  ```typescript
  - Storage Bucket: 'upload'
  - è·¯å¾„: 'avatars/{timestamp}_{filename}'
  - ç¼“å­˜: 3600 ç§’
  - è‡ªåŠ¨è¦†ç›–: false
  ```

### 3. ç”¨æˆ·ç»‘å®šåŠŸèƒ½ä¼˜åŒ– (`actions.ts`)
- **ä½ç½®**: `app/dashboard/girls/actions.ts`
- **æœç´¢èƒ½åŠ›å¢å¼º**:
  - âœ… æ”¯æŒé€šè¿‡ `user_id` ç²¾ç¡®æœç´¢
  - âœ… æ”¯æŒé€šè¿‡ `email` æ¨¡ç³Šæœç´¢ï¼ˆåŒ…å« @ ç¬¦å·ï¼‰
  - âœ… æ”¯æŒé€šè¿‡ `phone` æ¨¡ç³Šæœç´¢ï¼ˆçº¯æ•°å­—ï¼‰
  - âœ… æ”¯æŒé€šè¿‡ `display_name` æ¨¡ç³Šæœç´¢

- **ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º**:
  - ä¼˜å…ˆæ˜¾ç¤ºï¼š`phone` > `email` > `display_name`
  - ç¼–è¾‘æŠ€å¸ˆæ—¶è‡ªåŠ¨åŠ è½½å·²ç»‘å®šç”¨æˆ·ä¿¡æ¯
  - æ˜¾ç¤ºæ ¼å¼ï¼š`{phone/email} â€¢ {display_name} â€¢ {user_id}`

## ğŸ“¦ æ–°å¢ä¾èµ–

```bash
npm install react-image-crop
```

å·²å®‰è£…ç‰ˆæœ¬ä¼šè‡ªåŠ¨æ·»åŠ åˆ° `package.json`

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. æ–°å»ºæŠ€å¸ˆå¹¶ä¸Šä¼ å¤´åƒ
```
1. ç‚¹å‡»"æ–°å»ºæŠ€å¸ˆ"æŒ‰é’®
2. ç‚¹å‡»å¤´åƒåŒºåŸŸé€‰æ‹©å›¾ç‰‡
3. åœ¨è£å‰ªå™¨ä¸­é€‰æ‹©æ¯”ä¾‹ï¼ˆ3:4 / 1:1 / 9:16ï¼‰
4. è°ƒæ•´ç¼©æ”¾ã€æ—‹è½¬
5. ç‚¹å‡»"ç¡®è®¤è£å‰ª"
6. å¡«å†™å…¶ä»–ä¿¡æ¯
7. æäº¤è¡¨å• â†’ æµç¨‹ï¼š
   a. å…ˆåˆ›å»ºæŠ€å¸ˆè®°å½•ï¼ˆè·å– girl_idï¼‰
   b. ä¸Šä¼ å¤´åƒåˆ° avatars/{girl_id}/ æ–‡ä»¶å¤¹
   c. æ›´æ–°æŠ€å¸ˆçš„ avatar_url
```

### 2. ç¼–è¾‘æŠ€å¸ˆå¹¶æ›´æ¢å¤´åƒ
```
1. ç‚¹å‡»æŠ€å¸ˆåˆ—è¡¨ä¸­çš„"ç¼–è¾‘"
2. å·²ç»‘å®šç”¨æˆ·ä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼ˆæ‰‹æœºå·/é‚®ç®±ï¼‰
3. ç‚¹å‡»å¤´åƒåŒºåŸŸé€‰æ‹©æ–°å›¾ç‰‡
4. è£å‰ªåæäº¤ â†’ æ›´æ–°å¤´åƒ
```

### 3. ç»‘å®šç”¨æˆ·è´¦å·
```
1. åœ¨"ç”¨æˆ·ç»‘å®š"åŒºåŸŸè¾“å…¥ï¼š
   - ç”¨æˆ· IDï¼ˆ36ä½UUIDï¼‰
   - é‚®ç®±ï¼ˆåŒ…å«@ç¬¦å·ï¼‰
   - æ‰‹æœºå·ï¼ˆçº¯æ•°å­—ï¼‰
   - æ˜µç§°ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰
2. æŒ‰å›è½¦æˆ–ç‚¹å‡»æœç´¢æŒ‰é’®
3. ä»ç»“æœåˆ—è¡¨é€‰æ‹©ç”¨æˆ·
4. å·²ç»‘å®šç”¨æˆ·æ˜¾ç¤ºä¸ºç»¿è‰²å¡ç‰‡
```

## ğŸ—‚ï¸ Supabase Storage ç»“æ„

```
upload/
â””â”€â”€ avatars/
    â”œâ”€â”€ {girl_id_1}/
    â”‚   â”œâ”€â”€ 1733829384729_avatar.jpg
    â”‚   â”œâ”€â”€ 1733829485832_avatar_2.jpg
    â”‚   â””â”€â”€ ...
    â”œâ”€â”€ {girl_id_2}/
    â”‚   â”œâ”€â”€ 1733829584729_avatar.jpg
    â”‚   â””â”€â”€ ...
    â””â”€â”€ ...
```

**è·¯å¾„æ ¼å¼**: `avatars/{girl_id}/{timestamp}_{åŸæ–‡ä»¶å}`
**ä¼˜åŠ¿**: 
- æ¯ä¸ªæŠ€å¸ˆçš„å¤´åƒç‹¬ç«‹æ–‡ä»¶å¤¹ï¼Œæ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾
- æ”¯æŒå¤šä¸ªå†å²å¤´åƒä¿å­˜
- ä¾¿äºæ‰¹é‡æ“ä½œå’Œæ¸…ç†

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Storage é…ç½®
ç¡®ä¿ Supabase Storage ä¸­çš„ `upload` bucket å·²åˆ›å»ºå¹¶è®¾ç½®ä¸º **public**ï¼š
```sql
-- åœ¨ Supabase Dashboard â†’ Storage â†’ upload bucket
-- Settings â†’ Public: ON
```

### 2. RLS ç­–ç•¥
ç¡®ä¿æœ‰é€‚å½“çš„ Storage RLS ç­–ç•¥å…è®¸ä¸Šä¼ ï¼š
```sql
-- å…è®¸è®¤è¯ç”¨æˆ·ä¸Šä¼ åˆ° avatars æ–‡ä»¶å¤¹
CREATE POLICY "Allow authenticated uploads to avatars"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'upload' AND (storage.foldername(name))[1] = 'avatars');

-- å…è®¸æ‰€æœ‰äººè¯»å– avatars
CREATE POLICY "Allow public read access to avatars"
ON storage.objects FOR SELECT
TO public
USING (bucket_id = 'upload' AND (storage.foldername(name))[1] = 'avatars');
```

### 3. å›¾ç‰‡è´¨é‡
- **æ— å‹ç¼©**: `canvas.toBlob()` çš„è´¨é‡å‚æ•°è®¾ç½®ä¸º `1.0`
- **æ ¼å¼**: JPEG
- **DPI**: ä½¿ç”¨ `window.devicePixelRatio` é€‚é…é«˜åˆ†è¾¨ç‡å±å¹•

### 4. ç”¨æˆ·ç»‘å®šé—®é¢˜ä¿®å¤
- âœ… å·²ä¿®å¤ç¼–è¾‘æ—¶ä¸æ˜¾ç¤ºå·²ç»‘å®šç”¨æˆ·çš„é—®é¢˜
- âœ… `searchUsers` å‡½æ•°ç°åœ¨æ”¯æŒé€šè¿‡ `user_id` ç›´æ¥æŸ¥è¯¢
- âœ… `loadUserInfo` å‡½æ•°ä¼šåœ¨ç¼–è¾‘å¯¹è¯æ¡†æ‰“å¼€æ—¶è‡ªåŠ¨è°ƒç”¨

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] æ–°å»ºæŠ€å¸ˆ â†’ ä¸Šä¼ å¤´åƒ â†’ ä¿å­˜æˆåŠŸ
- [ ] ç¼–è¾‘æŠ€å¸ˆ â†’ æ›´æ¢å¤´åƒ â†’ æ›´æ–°æˆåŠŸ
- [ ] è£å‰ªæ¯”ä¾‹åˆ‡æ¢ â†’ 3:4 / 1:1 / 9:16 æ­£å¸¸å·¥ä½œ
- [ ] å›¾ç‰‡ç¼©æ”¾ â†’ 0.5x ~ 3x æ­£å¸¸
- [ ] å›¾ç‰‡æ—‹è½¬ â†’ 90åº¦å¢é‡æ­£å¸¸
- [ ] é‡ç½®åŠŸèƒ½ â†’ æ¢å¤åˆå§‹çŠ¶æ€
- [ ] ç”¨æˆ·ç»‘å®š â†’ æœç´¢æ˜¾ç¤ºæ­£ç¡®
- [ ] ç¼–è¾‘å·²ç»‘å®šç”¨æˆ·çš„æŠ€å¸ˆ â†’ ç”¨æˆ·ä¿¡æ¯è‡ªåŠ¨æ˜¾ç¤º
- [ ] ä¸Šä¼ åå¤´åƒåœ¨åˆ—è¡¨ä¸­æ­£ç¡®æ˜¾ç¤º
- [ ] å¤´åƒåœ¨ Supabase Storage ä¸­æ­£ç¡®å­˜å‚¨

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `components/girls/GirlImageCropper.tsx` - è£å‰ªå™¨ç»„ä»¶
- `components/girls/GirlFormDialog.tsx` - è¡¨å•å¯¹è¯æ¡†ï¼ˆå«ä¸Šä¼ é€»è¾‘ï¼‰
- `app/dashboard/girls/actions.ts` - Server Actionsï¼ˆå«ç”¨æˆ·æœç´¢ï¼‰
- `lib/supabase.ts` - Supabase å®¢æˆ·ç«¯é…ç½®

## ğŸ¨ ç”¨æˆ·ç»‘å®šæ ·å¼ä¼˜åŒ–

å·²ç»‘å®šç”¨æˆ·çš„æ˜¾ç¤ºæ ·å¼å·²ä¼˜åŒ–ï¼š
- âœ… ä½¿ç”¨ `border-primary` ä¸»è‰²è°ƒè¾¹æ¡†
- âœ… æ·¡è‰²èƒŒæ™¯ `bg-primary/5`
- âœ… ä½¿ç”¨ Badge ç»„ä»¶æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
- âœ… ç§»é™¤éšæ„çš„èƒŒæ™¯è‰²ï¼Œä¿æŒè®¾è®¡ä¸€è‡´æ€§
- âœ… æ‚¬åœæ•ˆæœä¼˜åŒ–ï¼ˆè§£ç»‘æŒ‰é’®ï¼‰

## ğŸ‰ å®ŒæˆçŠ¶æ€

- âœ… å¤´åƒè£å‰ªåŠŸèƒ½ï¼ˆ3ç§æ¯”ä¾‹ï¼‰
- âœ… å¤´åƒä¸Šä¼ åˆ° Supabase Storage
- âœ… **æŒ‰æŠ€å¸ˆIDåˆ†æ–‡ä»¶å¤¹å­˜å‚¨**
- âœ… ä¿æŒåŸå›¾è´¨é‡ï¼ˆæ— å‹ç¼©ï¼‰
- âœ… ç”¨æˆ·ç»‘å®šæ˜¾ç¤ºä¿®å¤
- âœ… **ç”¨æˆ·ç»‘å®šæ ·å¼ä¼˜åŒ–**
- âœ… ç”¨æˆ·æœç´¢åŠŸèƒ½å¢å¼º
- âœ… æ—  TypeScript é”™è¯¯
- âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…

